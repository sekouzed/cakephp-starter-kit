<?php
function slug($string, $replacement = '-') {
	return strtolower(Inflector::slug($string, $replacement));
}

function getPreferedLang($data, $field = 'title', $prefered = TXT_LANG, $langs = array()) {
	$fieldPrefix = $field.'_';
	
	if (isset($data[$fieldPrefix.$prefered]) && !empty($data[$fieldPrefix.$prefered])) {
		return $data[$fieldPrefix.$prefered];
	}
	
	if (empty($langs)) {
		$langs = array_keys(Configure::read('Config.languages'));
	}
	
	foreach ($langs as $lang) {
		if (isset($data[$fieldPrefix.$lang]) && !empty($data[$fieldPrefix.$lang])) {
			return $data[$fieldPrefix.$lang];
		}
	}
	
	if (isset($data[$field]) && !empty($data[$field])) {
		return $data[$field];
	}
}

function removeLineBreaks($string, $replaceBy = ' ') {
	return preg_replace("/(\r\n|\n|\r)/", $replaceBy, $string);
}

function redirect($url) {
	header("Status: 301 Moved Permanently");
	header("Location: ".$url);
	exit();
}

//http://www.php.net/manual/fr/function.hexdec.php#74092
function getContrastColor($color) {
    return (hexdec($color) > 0xffffff/2) ? '000000' : 'ffffff';
}

function truncate($string, $max, $rep = '...') {
	$stringlength = strlen($string);
	$string = $string." ";
	$string = substr($string,0,$max);
	$string = substr($string,0,strrpos($string,' '));
	if ($stringlength > $max)
	 $string = $string.$rep;
	
	return $string;
}

function parse_csv_file($file, $columnheadings = false, $delimiter = ',', $enclosure = "\"") {
	$row = 1;
	$rows = array();
	$handle = fopen($file, 'r');
	
	while (($data = fgetcsv($handle, 1000, $delimiter, $enclosure )) !== FALSE) {
		if (!($columnheadings == false) && ($row == 1)) {
			$headingTexts = $data;
		} elseif (!($columnheadings == false)) {
			foreach ($data as $key => $value) {
				unset($data[$key]);
				$data[$headingTexts[$key]] = $value;
			}
			$rows[] = $data;
		} else {
			$rows[] = $data;
		}
		$row++;
	}
	
	fclose($handle);
	return $rows;
}

/*
 * GPS
 */
function getGPSDistance($long1, $lat1, $long2, $lat2) {
	$earth_radius = 6367000;   // Terre = sphÃ¨re de 6367km de rayon
	$rlo1 = deg2rad($long1);
	$rla1 = deg2rad($lat1);
	$rlo2 = deg2rad($long2);
	$rla2 = deg2rad($lat2);

	$dlo = ($rlo2 - $rlo1) / 2;
	$dla = ($rla2 - $rla1) / 2;
	$a = (sin($dla) * sin($dla)) + cos($rla1) * cos($rla2) * (sin($dlo) * sin($dlo));
	$d = 2 * atan2(sqrt($a), sqrt(1 - $a));

	return ($earth_radius * $d);
} 

function friendlyGPSCoord($coord) {
	// http://en.wikipedia.org/wiki/Geographic_coordinate_conversion
	return sprintf("%0.0f&#176; %2.3f'",
		floor(abs($coord)),
		60*(abs($coord)-floor(abs($coord))));
}

function friendlyGPSCoords($latitude, $longitude) {
	// http://en.wikipedia.org/wiki/Geographic_coordinate_conversion
	return sprintf("%s %s, %s %s",
		($latitude>0)?"N":"S",  friendlyGPSCoord($latitude),
		($longitude>0)?"E":"W", friendlyGPSCoord($longitude));
}

function decimalToDMS($dec, $returnArray = false) {
	$vars = explode(".", $dec);
	$deg = $vars[0];
	$tempma = "0." . $vars[1];

	$tempma = $tempma * 3600;
	$min = floor($tempma / 60);
	$sec = $tempma - ($min * 60);

	if ($returnArray) {
		return array("deg" => $deg, "min" => $min, "sec" => round($sec));
	} else {
		$html = $deg . '&#176;&nbsp;' . $min . '\'&nbsp;' . $sec . '&#34;';
		return $html;
	}
}

function DMSToDecimal($deg,$min,$sec) {
	// Converts DMS ( Degrees / minutes / seconds )
	// to decimal format longitude / latitude
	return $deg+((($min*60)+($sec))/3600);
}